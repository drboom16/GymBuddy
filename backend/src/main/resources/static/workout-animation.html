<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout - GymBuddy</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Arms animation CSS removed - using arms.gif instead -->
    <!-- Chest animation CSS removed - using chest.gif instead -->
    <!-- Back animation CSS removed - using back.gif instead -->
    <link rel="stylesheet" href="styles/design-system.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: var(--background-cream);
            font-family: var(--font-family);
            color: var(--text-primary);
        }

        .workout-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--background-cream);
            z-index: 0;
            display: block;
            overflow: hidden;
        }

        .go-text {
            font-family: var(--font-family);
            position: fixed;
            top: 50%;
            left: 0;
            transform: translate(-100%, -50%);
            font-size: 120px;
            font-weight: 700;
            color: var(--text-primary);
            z-index: 2600;
            opacity: 1;
            transition: transform 0.5s ease;
            letter-spacing: -1px;
        }

        .go-text.show {
            transform: translate(calc(50vw - 50%), -50%);
        }

        .go-text.exit {
            transform: translate(150vw, -50%);
            transition: transform 0.6s ease;
        }

        .back-button {
            position: fixed;
            top: 60px;
            left: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            padding: 0;
            background: var(--background-white);
            border: 2px solid #000;
            border-radius: var(--radius-md);
            cursor: pointer;
            z-index: 3100;
            opacity: 1;
            transition: all 0.2s;
            box-shadow: 3px 3px 0 0 #000;
        }

        .back-button i,
        .back-button svg {
            width: 20px;
            height: 20px;
            stroke: var(--text-primary);
            stroke-width: 2.5;
        }

        .back-button:hover {
            background: var(--neutral-gray-light);
            transform: translateY(-2px);
            box-shadow: 4px 4px 0 0 #000;
        }

        .back-button:active {
            transform: translateY(0);
            box-shadow: 3px 3px 0 0 #000;
        }

        .timer {
            position: fixed;
            top: 60px;
            right: 20px;
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            z-index: 2800;
            font-family: var(--font-family);
            letter-spacing: -1px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        /* Exit Training Modal - matches end-workout-confirm-modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 300;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-overlay .modal {
            background: var(--background-white);
            border-radius: var(--radius-xl);
            padding: var(--spacing-xl);
            max-width: 400px;
            width: 85%;
            border: 2px solid #000;
        }

        .modal-overlay .modal-title {
            font-size: var(--font-size-xl);
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: var(--spacing-lg);
        }

        .modal-overlay .modal-message {
            font-size: var(--font-size-base);
            color: var(--text-secondary);
            margin-bottom: var(--spacing-xl);
            line-height: 1.5;
        }

        .modal-overlay .modal-actions {
            display: flex;
            gap: var(--spacing-md);
        }

        .modal-overlay .btn-cancel {
            flex: 1;
            padding: var(--spacing-md);
            background: var(--background-white);
            color: var(--text-primary);
            border: 2px solid #000;
            border-radius: var(--radius-md);
            font-size: var(--font-size-base);
            font-weight: 600;
            cursor: pointer;
        }

        .modal-overlay .btn-confirm {
            flex: 1;
            padding: var(--spacing-md);
            background: #dc2626;
            color: white;
            border: 2px solid #000;
            border-radius: var(--radius-md);
            font-size: var(--font-size-base);
            font-weight: 600;
            cursor: pointer;
        }

        .modal-overlay .btn-confirm:hover {
            background: #b91c1c;
        }

        .workout-complete-modal {
            z-index: 3200;
        }

        .workout-complete-modal .modal {
            text-align: center;
            padding: var(--spacing-xl);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 2px solid #000;
        }

        .workout-complete-modal .modal-header {
            border-bottom: none;
            margin-bottom: var(--spacing-lg);
            padding-bottom: 0;
        }

        .workout-complete-modal .modal-title {
            font-size: var(--font-size-3xl);
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -1px;
            margin-bottom: var(--spacing-md);
        }

        .workout-complete-message {
            font-size: var(--font-size-lg);
            font-weight: 500;
            color: var(--text-secondary);
            margin: 0 0 var(--spacing-xl) 0;
            line-height: 1.5;
        }

        .modal-button {
            background: var(--primary-green);
            color: white;
            border: 2px solid #000;
            padding: var(--spacing-md) var(--spacing-xl);
            font-size: var(--font-size-base);
            font-weight: 600;
            border-radius: var(--radius-sm);
            cursor: pointer;
            margin-top: 0;
            transition: all 0.2s;
            width: 100%;
            max-width: 300px;
        }

        .modal-button:hover {
            background: var(--primary-green);
            transform: translateY(-2px);
        }

        .modal-button:active {
            transform: translateY(0);
        }

        /* Legs GIF Container */
        .legs-gif-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .legs-gif-container.visible {
            opacity: 1;
        }

        .legs-gif-container img {
            width: 120vw;
            height: 120vh;
            object-fit: contain;
        }

        .arms-gif-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .arms-gif-container.visible {
            opacity: 1;
        }

        .arms-gif-container img {
            width: 65vw;
            height: 65vh;
            object-fit: contain;
        }

        .chest-gif-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chest-gif-container.visible {
            opacity: 1;
        }

        .chest-gif-container img {
            width: 100vw;
            height: 100vh;
            object-fit: contain;
        }

        .back-gif-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .back-gif-container.visible {
            opacity: 1;
        }

        .back-gif-container img {
            width: 90vw;
            height: 90vh;
            object-fit: contain;
        }

    </style>
</head>
<body>
    <!-- Workout Screen -->
    <div class="workout-screen" id="workoutScreen">
        <div class="go-text" id="goText">GO!</div>
        <div class="timer" id="timer">00:00</div>
        
        <!-- Legs GIF Container -->
        <div class="legs-gif-container" id="legsGifContainer">
            <img src="/public/legs.gif" alt="Legs Workout Animation" id="legsGif">
        </div>

        <!-- Arms GIF Container -->
        <div class="arms-gif-container" id="armsGifContainer">
            <img src="/public/arms.gif" alt="Arms Workout Animation" id="armsGif">
        </div>

        <!-- Chest GIF Container -->
        <div class="chest-gif-container" id="chestGifContainer">
            <img src="/public/chest.gif" alt="Chest Workout Animation" id="chestGif">
        </div>

        <!-- Back GIF Container -->
        <div class="back-gif-container" id="backGifContainer">
            <img src="/public/back.gif" alt="Back Workout Animation" id="backGif">
        </div>

        <button class="back-button" id="endExerciseButton" onclick="leaveWorkoutPopUp(event)">
            <i data-lucide="x"></i>
        </button>
    </div>

    <!-- Exit Training Modal -->
    <div class="modal-overlay" id="exitExerciseModal">
        <div class="modal">
            <h2 class="modal-title">End Exercise?</h2>
            <div class="modal-message">
                Are you sure you want to end this exercise?
            </div>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="document.getElementById('exitExerciseModal').classList.remove('active')">Cancel</button>
                <button class="btn-confirm" onclick="endExercise()">End Exercise</button>
            </div>
        </div>
    </div>

    <!-- Set Complete Modal -->
    <div class="modal-overlay workout-complete-modal" id="workoutCompleteModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Set Complete!</h2>
            </div>
            <div class="modal-content">
                <div class="workout-complete-message">Great work! Ready for the next set?</div>
                <div class="modal-actions" style="justify-content: center;">
                    <button class="modal-button" onclick="returnToHome()" style="max-width: 200px;">Go Back</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Motivational messages dictionary
        const motivationalMessages = [
            "Nice job, you smashed it!",
            "Incredible work! You're a champion!",
            "You crushed that workout!",
            "Amazing effort! You're unstoppable!",
            "Outstanding! You're getting stronger!",
            "Fantastic! You pushed through!",
            "Well done! You're a beast!",
            "Excellent work! Keep it up!",
            "You nailed it! So proud!",
            "Incredible! You're on fire!",
            "Outstanding performance!",
            "You're a workout warrior!",
            "Brilliant! You're unstoppable!",
            "Amazing! You're building greatness!",
            "You're absolutely crushing it!",
            "Phenomenal work! Keep going!",
            "You're a fitness legend!",
            "Incredible dedication!",
            "You're making progress every day!",
            "Outstanding commitment!"
        ];

        function getRandomMotivationalMessage() {
            const randomIndex = Math.floor(Math.random() * motivationalMessages.length);
            return motivationalMessages[randomIndex];
        }

        function showWorkoutCompleteModal() {
            // Clear countdown interval if it exists
            if (window.countdownInterval) {
                clearInterval(window.countdownInterval);
                window.countdownInterval = null;
            }

            const modal = document.getElementById('workoutCompleteModal');
            modal.classList.add('active');
            
            // Save workout to backend
            saveWorkoutExercise();
        }
        
        async function saveWorkoutExercise() {
            try {
                const params = new URLSearchParams(window.location.search);
                const durationString = params.get("duration");
                const durationInSeconds = parseDuration(durationString || "30s");
                
                const exerciseResponse = {
                    type: params.get("type"),
                    duration: durationInSeconds,
                };

                // Saves an ExerciseResponse
                const request = await fetch(`/api/achievements/exercise-response`, {
                    method: 'PUT',
                    headers: {
                        'Content-type': 'application/json',
                    },
                    body: JSON.stringify(exerciseResponse),
                });
                
                if (request.ok) {
                    console.log('Workout saved successfully');
                } else {
                    console.error('Failed to save workout:', request.statusText);
                }
            } catch (error) {
                console.error('Error saving workout:', error);
            }
        }

        async function returnToHome() {
            const params = new URLSearchParams(window.location.search);
            const workoutId = params.get('workoutId');
            const exerciseIndex = parseInt(params.get('exerciseIndex'));
            const setIndex = parseInt(params.get('setIndex'));

            // Mark set as complete on backend
            if (workoutId && !isNaN(exerciseIndex) && !isNaN(setIndex)) {
                try {
                    const response = await fetch(`/api/workouts/${workoutId}/exercises/${exerciseIndex}/sets/${setIndex}/complete`, {
                        method: 'PATCH'
                    });
                    
                    if (response.ok) {
                        console.log('Set marked as complete on backend');
                    } else {
                        console.error('Failed to mark set as complete:', response.statusText);
                    }
                } catch (error) {
                    console.error('Error marking set as complete:', error);
                }
            }

            // Return to the workout detail page
            if (workoutId) {
                window.location.href = `/train/${workoutId}`;
            } else {
                // Default behavior: return to home
                window.location.href = '/home';
            }
        }

        function leaveWorkoutPopUp(event) {
            const exitExerciseModal = document.getElementById('exitExerciseModal');
            exitExerciseModal.classList.add('active');
        }
    
        async function endExercise() {
            // Clear countdown interval if it exists
            if (window.countdownInterval) {
                clearInterval(window.countdownInterval);
                window.countdownInterval = null;
            }

            // Check if we came from a workout detail page
            const params = new URLSearchParams(window.location.search);
            const workoutId = params.get('workoutId');
            
            if (workoutId) {
                // Return to workout detail page without completion
                window.location.href = `/train/${workoutId}`;
                return;
            }

            // Save workout even if ended early
            await saveWorkoutExercise();
            
            window.location = '/home';
        }
    
        function parseDuration(duration) {
            // Parse duration string like "30s", "1m", "2m", "3m" into seconds
            if (duration.endsWith('s')) {
                return parseInt(duration);
            } else if (duration.endsWith('m')) {
                return parseInt(duration) * 60;
            }
            return 30; // default to 30 seconds
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        async function loadWorkoutFragment(workoutType) {
            // All workouts now use GIFs, no fragments needed
            return true;
        }

        async function startWorkoutAnimation(workoutType, duration) {
            const goText = document.getElementById('goText');
            const timer = document.getElementById('timer');

            // Normalize workout type to uppercase for comparison
            const normalizedWorkoutType = workoutType.toUpperCase();

            console.log(`WORKOUT_TYPE: ${normalizedWorkoutType}`);
            console.log(`DURATION: ${duration}`);
    
            // Load the appropriate workout fragment (no-op now, all use GIFs)
            await loadWorkoutFragment(workoutType);

            // Step 1: GO! text pops up
            setTimeout(() => {
                goText.classList.add('show');
            }, 100);
    
            // Step 2: GO! dashes out
            setTimeout(() => {
                goText.classList.remove('show');
                goText.classList.add('exit');
            }, 900);

            // Step 3: Show workout animation and controls after GO! exits (900ms + 600ms transition = 1500ms)
            setTimeout(() => {
                if (normalizedWorkoutType === "ARMS") {
                    triggerArmsWorkout();
                } else if (normalizedWorkoutType === "BACK") {
                    triggerBackWorkout();
                } else if (normalizedWorkoutType === "CHEST") {
                    triggerChestWorkout();
                } else if (normalizedWorkoutType === "LEGS") {
                    triggerLegsWorkout();
                }

                // Show and start countdown timer (only after GO! has fully exited)
                let totalSeconds = parseDuration(duration);
                timer.textContent = formatTime(totalSeconds);
                timer.style.opacity = '1';

                // Start countdown
                const countdownInterval = setInterval(() => {
                    totalSeconds--;
                    timer.textContent = formatTime(totalSeconds);

                    if (totalSeconds <= 0) {
                        clearInterval(countdownInterval);
                        timer.textContent = '00:00';
                        // Show workout complete modal with random motivational message
                        showWorkoutCompleteModal();
                    }
                }, 1000);

                // Store interval ID globally so it can be cleared if workout is ended early
                window.countdownInterval = countdownInterval;
            }, 1500);
        } 

        function triggerChestWorkout() {
            const endButton = document.getElementById('endExerciseButton');
            const chestGifContainer = document.getElementById('chestGifContainer');
            
            if (endButton) {
                lucide.createIcons();
            }
            if (chestGifContainer) chestGifContainer.classList.add('visible');
        }

        function triggerArmsWorkout() {
            const endButton = document.getElementById('endExerciseButton');
            const armsGifContainer = document.getElementById('armsGifContainer');
            
            if (endButton) {
                lucide.createIcons();
            }
            if (armsGifContainer) armsGifContainer.classList.add('visible');
        }

        function triggerBackWorkout() {
            const endButton = document.getElementById('endExerciseButton');
            const backGifContainer = document.getElementById('backGifContainer');
            
            if (endButton) {
                lucide.createIcons();
            }
            if (backGifContainer) backGifContainer.classList.add('visible');
        }

        function triggerLegsWorkout() {
            const endButton = document.getElementById('endExerciseButton');
            const legsGifContainer = document.getElementById('legsGifContainer');
            
            if (endButton) {
                lucide.createIcons();
            }
            if (legsGifContainer) legsGifContainer.classList.add('visible');
        }

        // Read URL parameters and start workout animation
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize lucide icons
            lucide.createIcons();
            
            const params = new URLSearchParams(window.location.search);

            const workoutType = params.get('type');
            const duration = params.get('duration');
            
            if (workoutType && duration) {
                // Store workout data globally for saving later
                window.workoutType = workoutType;
                window.workoutDuration = duration;

                // Start workout animation immediately
                startWorkoutAnimation(workoutType, duration);
            } else {
                // If parameters are missing, redirect to train page
                window.location = '/train';
            }
        })

    </script>
</body>
</html>

