<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop - GymBuddy</title>
    <link rel="stylesheet" href="styles/design-system.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            background: var(--background-cream);
        }

        .header-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-2xl) var(--spacing-lg) var(--spacing-md) var(--spacing-lg);
            padding-top: calc(var(--spacing-2xl) + env(safe-area-inset-top, 0px));
        }

        .coin-display {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            background: white;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            border: 2px solid #000;
            box-shadow: var(--shadow-sm);
            font-weight: 600;
            font-size: var(--font-size-base);
        }

        .coin-display i,
        .coin-display svg {
            width: 20px;
            height: 20px;
            stroke: #f59e0b;
        }

        .gymbuddies-container {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            padding-bottom: var(--spacing-xl);
        }

        .gymbuddy-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--spacing-md);
            border: 2px solid #000;
            box-shadow: var(--shadow-md);
            position: relative;
            transform: translateY(-2px);
        }

        .gymbuddy-card.locked {
            opacity: 0.5;
            cursor: not-allowed;
            position: relative;
        }

        .locked-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.1);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }

        .locked-icon {
            width: 32px;
            height: 32px;
            stroke: var(--text-primary);
        }

        .gymbuddy-info {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            flex: 1;
        }

        .gymbuddy-image {
            width: 100px;
            height: 140px;
            border-radius: var(--radius-md);
            object-fit: contain;
            flex-shrink: 0;
            border: 2px solid #000;
            background: var(--background-cream);
        }

        .gymbuddy-details {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }

        .gymbuddy-name {
            font-size: var(--font-size-xl);
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .gymbuddy-price {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            font-size: var(--font-size-base);
            font-weight: 600;
            color: var(--text-primary);
        }

        .gymbuddy-price i,
        .gymbuddy-price svg {
            width: 20px;
            height: 20px;
            stroke: #f59e0b;
        }

        .coin-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: white;
            border: 2px solid #000;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: var(--shadow-sm);
            position: relative;
            flex-shrink: 0;
        }

        .coin-button:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .coin-button:active {
            transform: translateY(0);
            box-shadow: var(--shadow-sm);
        }

        .coin-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .coin-button:disabled:hover {
            transform: none;
            box-shadow: var(--shadow-sm);
        }

        .coin-button i[data-lucide="check"] {
            width: 28px;
            height: 28px;
            stroke: white;
            stroke-width: 3;
        }

        .coin-button.owned {
            background: var(--primary-green);
        }

        .coin-button.owned i,
        .coin-button.owned svg {
            stroke: white;
            fill: none;
        }

        .coin-button i,
        .coin-button svg {
            width: 32px;
            height: 32px;
            stroke: #f59e0b;
            fill: #fef3c7;
        }

        .coin-amount {
            position: absolute;
            font-size: var(--font-size-base);
            font-weight: 700;
            color: var(--text-primary);
            z-index: 1;
        }

        .loading {
            text-align: center;
            padding: var(--spacing-2xl);
            color: var(--text-secondary);
        }

        .empty-state {
            text-align: center;
            padding: var(--spacing-2xl);
            color: var(--text-secondary);
        }

        .empty-state i,
        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: var(--spacing-md);
            stroke: var(--text-secondary);
            opacity: 0.5;
        }

        /* Purchase Confirmation Modal */
        .purchase-confirm-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 300;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .purchase-confirm-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .purchase-confirm-modal .modal {
            background: var(--background-white);
            border-radius: var(--radius-xl);
            padding: var(--spacing-xl);
            max-width: 400px;
            width: 85%;
            border: 2px solid #000;
        }

        .purchase-confirm-modal .modal-title {
            font-size: var(--font-size-xl);
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: var(--spacing-lg);
        }

        .purchase-confirm-modal .modal-message {
            font-size: var(--font-size-base);
            color: var(--text-secondary);
            margin-bottom: var(--spacing-xl);
            line-height: 1.5;
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .purchase-confirm-modal .modal-message-text {
            flex: 1;
        }

        .purchase-confirm-modal .modal-message-image {
            width: 80px;
            height: 112px;
            border-radius: var(--radius-md);
            object-fit: contain;
            flex-shrink: 0;
            border: 2px solid #000;
            background: var(--background-cream);
        }

        .purchase-confirm-modal .modal-actions {
            display: flex;
            gap: var(--spacing-md);
        }

        .purchase-confirm-modal .btn-cancel {
            flex: 1;
            padding: var(--spacing-md);
            background: var(--background-white);
            color: var(--text-primary);
            border: 2px solid #000;
            border-radius: var(--radius-md);
            font-size: var(--font-size-base);
            font-weight: 600;
            cursor: pointer;
        }

        .purchase-confirm-modal .btn-confirm {
            flex: 1;
            padding: var(--spacing-md);
            background: var(--primary-green);
            color: white;
            border: 2px solid #000;
            border-radius: var(--radius-md);
            font-size: var(--font-size-base);
            font-weight: 600;
            cursor: pointer;
        }

        .purchase-confirm-modal .btn-confirm:hover {
            background: #059669;
        }

        .coming-soon-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.1);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: flex-start;
            justify-content: flex-end;
            pointer-events: none;
            padding: var(--spacing-sm);
        }

        .coming-soon-text {
            font-size: var(--font-size-base);
            font-weight: 600;
            color: var(--text-primary);
        }

        .gymbuddy-card.coming-soon {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="header-container">
        <h1 class="page-title-large" style="padding: 0; margin: 0;">Shop</h1>
        <div class="coin-display" id="userCoins">
            <i data-lucide="coins"></i>
            <span id="coinAmount">0</span>
        </div>
    </div>

    <div class="content-container">
        <div id="gymbuddiesList" class="gymbuddies-container">
            <div class="loading">Loading gymbuddies...</div>
        </div>
    </div>

    <div class="bottom-nav">
        <a href="/home" class="nav-item">
            <i data-lucide="home" class="nav-icon"></i>
        </a>
        <a href="/workouts" class="nav-item">
            <i data-lucide="clipboard-list" class="nav-icon"></i>
        </a>
        <a href="/train" class="nav-item" id="trainButton">
            <i data-lucide="dumbbell" class="nav-icon"></i>
        </a>
        <a href="/achievements" class="nav-item">
            <i data-lucide="medal" class="nav-icon"></i>
        </a>
        <a href="/shop" class="nav-item">
            <i data-lucide="shopping-cart" class="nav-icon"></i>
        </a>
    </div>

    <!-- Purchase Confirmation Modal -->
    <div class="purchase-confirm-modal" id="purchaseConfirmModal">
        <div class="modal">
            <h2 class="modal-title">Purchase EarthBuddy?</h2>
            <div class="modal-message" id="purchaseConfirmMessage">
                <div class="modal-message-text">
                    Are you sure you want to purchase EarthBuddy for <span id="purchaseCoinCost">0</span> coins?
                </div>
                <img id="purchaseGymBuddyImage" src="" alt="EarthBuddy" class="modal-message-image">
            </div>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closePurchaseModal()">Cancel</button>
                <button class="btn-confirm" onclick="confirmPurchase()">Purchase</button>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // Set active nav-item based on current page
        function setActiveNavItem() {
            const currentPath = window.location.pathname;
            const navItems = document.querySelectorAll('.nav-item');
            
            navItems.forEach(item => {
                item.classList.remove('active');
                const href = item.getAttribute('href');
                
                // Check if this nav-item matches the current page
                if (href) {
                    // Handle home page: both "/" and "/home" should activate the Home nav-item
                    if ((currentPath === '/home' || currentPath === '/') && (href === '/' || href === '/home')) {
                        item.classList.add('active');
                    } 
                    // For other pages, check exact match
                    else if (currentPath === href || currentPath === href + '.html') {
                        item.classList.add('active');
                    }
                }
            });
            
            // Reinitialize icons to apply stroke color changes
            lucide.createIcons();
        }

        // Set active nav-item on page load
        setActiveNavItem();

        // Load user coins from API
        async function loadUserCoins() {
            try {
                const response = await fetch('/api/user/coins');
                if (!response.ok) {
                    throw new Error('Failed to load user coins');
                }
                const data = await response.json();
                document.getElementById('coinAmount').textContent = data.coins || 0;
            } catch (error) {
                console.error('Error loading user coins:', error);
                document.getElementById('coinAmount').textContent = '0';
            }
        }

        let pendingPurchaseId = null;
        let pendingPurchaseCost = null;

        // Fetch and render gymbuddies
        async function loadGymBuddies() {
            const gymbuddiesList = document.getElementById('gymbuddiesList');
            
            try {
                // Fetch available gymbuddies and user's owned gymbuddies
                const [gymbuddiesResponse, ownedResponse] = await Promise.all([
                    fetch('/api/gymbuddies'),
                    fetch('/api/user/gymbuddies')
                ]);
                
                if (!gymbuddiesResponse.ok) {
                    throw new Error('Failed to load gymbuddies');
                }
                
                const gymbuddies = await gymbuddiesResponse.json();
                const ownedGymbuddies = ownedResponse.ok ? await ownedResponse.json() : [];
                const ownedIds = new Set(ownedGymbuddies.map(gb => gb.id));
                
                if (gymbuddies.length === 0) {
                    gymbuddiesList.innerHTML = `
                        <div class="empty-state">
                            <i data-lucide="users"></i>
                            <p>No gymbuddies available yet.</p>
                        </div>
                    `;
                    lucide.createIcons();
                    return;
                }
                
                // Sort gymbuddies: put LegendaryBuddy and Second Slot at the bottom
                const sortedGymbuddies = [...gymbuddies].sort((a, b) => {
                    if (a.name === 'Second Slot') return 1;
                    if (b.name === 'Second Slot') return -1;
                    if (a.name === 'LegendaryBuddy') return 1;
                    if (b.name === 'LegendaryBuddy') return -1;
                    return 0;
                });
                
                gymbuddiesList.innerHTML = sortedGymbuddies.map(gymbuddy => {
                    const isAvailable = gymbuddy.isAvailable !== false;
                    const isLocked = !isAvailable;
                    const isFree = gymbuddy.coinCost === 0;
                    const requiresDaily = gymbuddy.requiresAllDailyAchievements === true;
                    const lockMessage = requiresDaily ? 'Complete all daily achievements to unlock' : 'Complete all achievements to unlock';
                    const isEarthBuddy = gymbuddy.name === 'EarthBuddy';
                    const isComingSoon = !isEarthBuddy;
                    const isOwned = ownedIds.has(gymbuddy.id);
                    
                    return `
                        <div class="gymbuddy-card ${isLocked ? 'locked' : ''} ${isComingSoon ? 'coming-soon' : ''}">
                            ${isLocked ? '<div class="locked-overlay"><i data-lucide="lock" class="locked-icon"></i></div>' : ''}
                            ${isComingSoon ? '<div class="coming-soon-overlay"><div class="coming-soon-text">Coming Soon</div></div>' : ''}
                            <div class="gymbuddy-info">
                                <img src="${gymbuddy.imagePath}" alt="${gymbuddy.name}" class="gymbuddy-image">
                                <div class="gymbuddy-details">
                                    <h3 class="gymbuddy-name">${gymbuddy.name}</h3>
                                    ${isLocked ? `<p style="font-size: var(--font-size-xs); color: var(--text-secondary); margin-top: var(--spacing-xs);">${lockMessage}</p>` : ''}
                                </div>
                            </div>
                            ${!isComingSoon ? (isOwned ? `
                                <button class="coin-button owned" title="Owned">
                                    <i data-lucide="check"></i>
                                </button>
                            ` : isFree && isAvailable ? `
                                <button class="coin-button" onclick="purchaseGymBuddy(${gymbuddy.id}, ${gymbuddy.coinCost}, '${gymbuddy.imagePath}')" title="Claim for free">
                                    <i data-lucide="check"></i>
                                </button>
                            ` : !isFree ? `
                                <button class="coin-button" ${isLocked ? 'disabled' : ''} onclick="${isLocked ? '' : `purchaseGymBuddy(${gymbuddy.id}, ${gymbuddy.coinCost}, '${gymbuddy.imagePath}')`}" title="${isLocked ? lockMessage : `Purchase for ${gymbuddy.coinCost} coins`}" style="${isLocked ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                                    <i data-lucide="coins"></i>
                                    <span class="coin-amount">${gymbuddy.coinCost}</span>
                                </button>
                            ` : '') : ''}
                        </div>
                    `;
                }).join('');
                
                lucide.createIcons();
            } catch (error) {
                console.error('Error loading gymbuddies:', error);
                gymbuddiesList.innerHTML = `
                    <div class="empty-state">
                        <i data-lucide="alert-circle"></i>
                        <p>Failed to load gymbuddies. Please try again later.</p>
                    </div>
                `;
                lucide.createIcons();
            }
        }

        function purchaseGymBuddy(id, coinCost, imagePath) {
            pendingPurchaseId = id;
            pendingPurchaseCost = coinCost;
            document.getElementById('purchaseCoinCost').textContent = coinCost;
            document.getElementById('purchaseGymBuddyImage').src = imagePath;
            document.getElementById('purchaseConfirmModal').classList.add('active');
        }

        function closePurchaseModal() {
            document.getElementById('purchaseConfirmModal').classList.remove('active');
            pendingPurchaseId = null;
            pendingPurchaseCost = null;
        }

        async function confirmPurchase() {
            if (pendingPurchaseId && pendingPurchaseCost !== null) {
                try {
                    const response = await fetch(`/api/user/gymbuddies/${pendingPurchaseId}/purchase`, {
                        method: 'POST'
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok && result.success) {
                        // Purchase successful
                        closePurchaseModal();
                        // Reload gymbuddies and coins
                        loadGymBuddies();
                        loadUserCoins();
                    } else {
                        // Show error message
                        alert(result.message || 'Purchase failed. Please try again.');
                    }
                } catch (error) {
                    console.error('Error purchasing gymbuddy:', error);
                    alert('Failed to complete purchase. Please try again.');
                }
            }
        }

        // Close modal when clicking outside
        document.getElementById('purchaseConfirmModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closePurchaseModal();
            }
        });

        // Load gymbuddies and user coins on page load
        loadGymBuddies();
        loadUserCoins();
    </script>
</body>
</html>

